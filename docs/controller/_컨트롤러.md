# Jiny Admin 컨트롤러 구조 가이드

## 개요

Jiny Admin의 컨트롤러는 Single Action Controller(SAC) 패턴을 기반으로 구현됩니다. 각 컨트롤러는 하나의 특정 작업만을 담당하며, `__invoke()` 메소드를 통해 실행됩니다.

## 컨트롤러 타입

### 1. 메인 컨트롤러 (Index)
- **역할**: 목록 페이지 표시 및 데이터 조회
- **메소드**: `__invoke(Request $request)`
- **예시**: `AdminUsers`, `AdminPasswordLogs`, `AdminSessions`

### 2. Create 컨트롤러
- **역할**: 생성 폼 표시 및 데이터 검증
- **메소드**: `__invoke(Request $request)`
- **예시**: `AdminUsersCreate`, `AdminSessionsCreate`

### 3. Edit 컨트롤러
- **역할**: 수정 폼 표시 및 기존 데이터 로드
- **메소드**: `__invoke(Request $request, $id)`
- **예시**: `AdminUsersEdit`, `AdminSessionsEdit`

### 4. Show 컨트롤러
- **역할**: 상세 정보 표시
- **메소드**: `__invoke(Request $request, $id)`
- **예시**: `AdminUsersShow`, `AdminPasswordLogsShow`

### 5. Delete 컨트롤러
- **역할**: 삭제 확인 및 처리
- **메소드**: `__invoke(Request $request, $id)`
- **예시**: `AdminUsersDelete`, `AdminSessionsDelete`

## 기본 구조

### 1. 네임스페이스 및 의존성

```php
<?php

namespace Jiny\Admin\App\Http\Controllers\Admin\{ModuleName};

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Jiny\Admin\Services\JsonConfigService;
```

### 2. 클래스 구조

```php
class {ModuleName}{Action} extends Controller
{
    /**
     * JSON 설정 데이터
     * @var array|null
     */
    private $jsonData;
    
    /**
     * 생성자 - JSON 설정 로드
     */
    public function __construct()
    {
        $jsonConfigService = new JsonConfigService;
        $this->jsonData = $jsonConfigService->loadFromControllerPath(__DIR__);
    }
    
    /**
     * Single Action Controller 메인 메소드
     */
    public function __invoke(Request $request, $id = null)
    {
        // 구현
    }
}
```

## Hook 메소드 패턴

각 컨트롤러는 Livewire 컴포넌트와 연동하여 Hook 메소드를 통해 동작을 커스터마이징할 수 있습니다.

### 1. 메인 컨트롤러 (Index)

```php
/**
 * Hook: 데이터 조회 전 실행
 * @param mixed $wire Livewire 컴포넌트
 * @return false|mixed
 */
public function hookIndexing($wire)
{
    return false; // false면 정상 진행
}

/**
 * Hook: 데이터 조회 후 실행
 * @param mixed $wire Livewire 컴포넌트
 * @param mixed $rows 조회된 데이터
 * @return mixed
 */
public function hookIndexed($wire, $rows)
{
    return $rows;
}
```

### 2. Create 컨트롤러

```php
/**
 * Hook: 폼 초기화
 * @param mixed $wire Livewire 컴포넌트
 * @param array $form 폼 데이터
 * @return array
 */
public function hookCreating($wire, $form)
{
    return $form;
}

/**
 * Hook: 저장 전 처리
 * @param mixed $wire Livewire 컴포넌트
 * @param array $form 폼 데이터
 * @return array|string 성공시 배열, 실패시 에러 메시지
 */
public function hookStoring($wire, $form)
{
    return $form;
}

/**
 * Hook: 저장 후 처리
 * @param mixed $wire Livewire 컴포넌트
 * @param array $form 저장된 데이터
 * @return void
 */
public function hookStored($wire, $form)
{
    // 후처리 로직
}
```

### 3. Edit 컨트롤러

```php
/**
 * Hook: 수정 폼 초기화
 * @param mixed $wire Livewire 컴포넌트
 * @param array $form 기존 데이터
 * @return array
 */
public function hookEditing($wire, $form)
{
    return $form;
}

/**
 * Hook: 업데이트 전 처리
 * @param mixed $wire Livewire 컴포넌트
 * @param array $form 수정된 데이터
 * @return array|string
 */
public function hookUpdating($wire, $form)
{
    return $form;
}

/**
 * Hook: 업데이트 후 처리
 * @param mixed $wire Livewire 컴포넌트
 * @param array $form 업데이트된 데이터
 * @return void
 */
public function hookUpdated($wire, $form)
{
    // 후처리 로직
}
```

### 4. Delete 컨트롤러

```php
/**
 * Hook: 삭제 전 처리
 * @param mixed $wire Livewire 컴포넌트
 * @param array $ids 삭제할 ID 목록
 * @return bool|string true면 진행, false나 문자열이면 중단
 */
public function hookDeleting($wire, $ids)
{
    return true;
}

/**
 * Hook: 삭제 후 처리
 * @param mixed $wire Livewire 컴포넌트
 * @param array $ids 삭제된 ID 목록
 * @return void
 */
public function hookDeleted($wire, $ids)
{
    // 후처리 로직
}
```

## 공통 메소드

### 1. JSON 설정 로드

모든 컨트롤러는 생성자에서 JSON 설정을 로드합니다:

```php
public function __construct()
{
    $jsonConfigService = new JsonConfigService;
    $this->jsonData = $jsonConfigService->loadFromControllerPath(__DIR__);
}
```

### 2. 뷰 반환 패턴

```php
public function __invoke(Request $request)
{
    // JSON 데이터 확인
    if (!$this->jsonData) {
        return response('Error: JSON 설정을 로드할 수 없습니다.', 500);
    }
    
    // 템플릿 경로 확인
    $templateKey = 'template.' . $this->getTemplateKey();
    if (!isset($this->jsonData[$templateKey])) {
        return response("Error: {$templateKey} 설정이 필요합니다.", 500);
    }
    
    // 뷰 데이터 준비
    $jsonPath = __DIR__ . DIRECTORY_SEPARATOR . $this->getModuleName() . '.json';
    $this->jsonData['controllerClass'] = get_class($this);
    
    return view($this->jsonData[$templateKey], [
        'jsonData' => $this->jsonData,
        'jsonPath' => $jsonPath,
        'settingsPath' => $jsonPath,
        'controllerClass' => static::class
    ]);
}
```

### 3. ID 파라미터 처리

Edit, Show, Delete 컨트롤러는 ID 파라미터를 받습니다:

```php
public function __invoke(Request $request, $id)
{
    // 데이터 조회
    $tableName = $this->jsonData['table']['name'] ?? null;
    if (!$tableName) {
        return response('Error: 테이블 설정이 필요합니다.', 500);
    }
    
    $data = DB::table($tableName)->where('id', $id)->first();
    
    if (!$data) {
        return response('Error: 데이터를 찾을 수 없습니다.', 404);
    }
    
    // 뷰 반환 로직...
}
```

## 파일 구조

각 모듈은 다음과 같은 파일 구조를 가집니다:

```
Admin{ModuleName}/
├── Admin{ModuleName}.php        # 메인 컨트롤러 (목록)
├── Admin{ModuleName}Create.php  # 생성 컨트롤러
├── Admin{ModuleName}Edit.php    # 수정 컨트롤러
├── Admin{ModuleName}Show.php    # 상세 컨트롤러
├── Admin{ModuleName}Delete.php  # 삭제 컨트롤러
└── Admin{ModuleName}.json       # JSON 설정 파일
```

## 네이밍 규칙

1. **모듈명**: PascalCase, `Admin` 접두사 필수 (예: `AdminUsers`)
2. **액션 접미사**: 
   - Create: 생성 폼
   - Edit: 수정 폼
   - Show: 상세 보기
   - Delete: 삭제 처리
3. **메소드명**: 
   - 메인 메소드: `__invoke()`
   - Hook 메소드: `hook{Action}{State}()` (예: `hookIndexing()`)

## 보안 고려사항

1. **권한 검증**: 각 컨트롤러에서 사용자 권한을 검증
2. **데이터 검증**: 입력 데이터의 유효성 검증
3. **CSRF 보호**: Laravel의 CSRF 토큰 활용
4. **SQL 인젝션 방지**: Query Builder 사용
5. **XSS 방지**: 출력 시 이스케이핑

## 트랜잭션 처리

데이터 변경 작업은 트랜잭션으로 보호:

```php
DB::beginTransaction();
try {
    // 데이터 처리
    DB::commit();
    return redirect()->route($route)->with('success', $message);
} catch (\Exception $e) {
    DB::rollBack();
    return back()->withErrors(['error' => $e->getMessage()]);
}
```

## 로깅

중요한 작업은 로그에 기록:

```php
Log::channel('admin')->info('User deleted', [
    'id' => $id,
    'deleted_by' => Auth::id(),
    'ip' => $request->ip()
]);
```

## JSON 설정 연동

JSON 설정 파일과의 연동에 대한 자세한 내용은 [컨트롤러_json.md](./컨트롤러_json.md) 문서를 참조하세요.

## 모범 사례

1. **단일 책임 원칙**: 각 컨트롤러는 하나의 작업만 담당
2. **Hook 패턴 활용**: Livewire 컴포넌트와의 연동을 위해 Hook 메소드 구현
3. **에러 처리**: 명확한 에러 메시지와 적절한 HTTP 상태 코드 반환
4. **코드 재사용**: 공통 로직은 trait이나 서비스 클래스로 분리
5. **문서화**: PHPDoc 주석으로 메소드와 Hook의 동작 명시

## 일반적인 오류 및 해결책

### 1. Undefined variable $form 오류

#### 증상
Edit 컨트롤러에서 수정 페이지(/admin/module/{id}/edit) 접근 시 발생:
```
ErrorException: Undefined variable $form
```

#### 원인
Edit 컨트롤러의 `__invoke` 메소드에서 `$form` 변수를 view에 전달하지 않아서 발생합니다. template/edit.blade.php 파일은 Livewire 컴포넌트에 `$form` 데이터를 전달하기 위해 이 변수를 필요로 합니다.

#### 해결책
Edit 컨트롤러의 `__invoke` 메소드를 다음과 같이 수정합니다:

```php
public function __invoke(Request $request, $id)
{
    // ... 기존 코드 ...
    
    // 데이터베이스에서 데이터 조회
    $data = DB::table($tableName)->where('id', $id)->first();
    
    if (!$data) {
        return response('Error: 데이터를 찾을 수 없습니다.', 404);
    }
    
    // 중요: 객체를 배열로 변환하여 $form 변수 생성
    $form = (array) $data;
    
    // ... 기존 코드 ...
    
    return view($this->jsonData['template']['edit'], [
        'jsonData' => $this->jsonData,
        'jsonPath' => $jsonPath,
        'settingsPath' => $settingsPath,
        'controllerClass' => static::class,
        'data' => $data,
        'form' => $form,  // 중요: $form 변수를 반드시 추가
        'id' => $id,
    ]);
}
```

#### 주의사항
- `DB::table()`로 조회한 데이터는 stdClass 객체이므로 `(array)` 캐스팅이 필요합니다
- Create 컨트롤러에서는 빈 배열로 초기화: `$form = []`
- Show 컨트롤러에서는 `$form` 대신 `$data`만 사용해도 됩니다

#### 예방법
admin:make 명령으로 컨트롤러 생성 시 stub 템플릿에 이미 `$form` 변수가 포함되어 있어야 합니다. stub 파일을 확인하고 필요시 수정하세요:

```php
// stubs/controller-edit.stub
return view($this->jsonData['template']['edit'], [
    'jsonData' => $this->jsonData,
    'jsonPath' => $jsonPath,
    'settingsPath' => $settingsPath,
    'controllerClass' => static::class,
    'data' => $data,
    'form' => (array) $data,  // 이 줄이 포함되어야 함
    'id' => $id,
]);
```

### 2. Class not found 오류

#### 증상
컨트롤러 접근 시 클래스를 찾을 수 없다는 오류 발생

#### 원인
stub 파일의 플레이스홀더({{namespace}}, {{class}} 등)가 실제 값으로 치환되지 않음

#### 해결책
생성된 컨트롤러 파일을 직접 수정:
```php
// 잘못된 경우
namespace {{namespace}};
class {{class}} extends Controller

// 올바른 경우
namespace Jiny\Admin\App\Http\Controllers\Admin\AdminModule;
class AdminModuleEdit extends Controller
```

### 3. JSON 설정 파일 로드 실패

#### 증상
"JSON 설정을 로드할 수 없습니다" 오류 메시지

#### 원인
- JSON 파일이 컨트롤러와 같은 디렉토리에 없음
- JSON 파일명이 잘못됨
- JSON 구문 오류

#### 해결책
1. JSON 파일 위치 확인: 컨트롤러와 같은 폴더에 `Admin{Module}.json` 파일이 있어야 함
2. JSON 구문 검증: JSON 린터로 문법 오류 확인
3. 파일 권한 확인: 읽기 권한이 있는지 확인