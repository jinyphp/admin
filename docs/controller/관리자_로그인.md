# 관리자 로그인 시스템

## 📌 개요

@jiny/admin 패키지는 일반 사용자와 분리된 전용 관리자 로그인 시스템을 제공합니다. 강력한 보안 기능과 2단계 인증을 통해 관리자 계정을 보호합니다.

## 🔐 분리된 전용 관리자 로그인 페이지

### 접근 경로
```
/admin/login
```

### 특징
- **독립된 인증 시스템**: 일반 사용자 로그인과 완전히 분리
- **전용 세션 관리**: 관리자 전용 세션 테이블 사용
- **IP 기반 접근 제어**: 허용된 IP에서만 접근 가능 (선택사항)
- **커스텀 디자인**: 관리자 전용 UI/UX

### 로그인 프로세스
1. `/admin/login` 접속
2. 이메일/비밀번호 입력
3. 비밀번호 보안 체크 (차단 여부 확인)
4. 2FA 인증 (활성화된 경우)
5. 관리자 대시보드 이동

## 🛡️ 비밀번호 보안 관리

### 자동 차단 시스템

무차별 대입 공격(Brute Force Attack)을 방지하기 위한 자동 차단 시스템이 구현되어 있습니다.

#### 차단 정책
- **차단 조건**: 동일 이메일/IP에서 5회 이상 로그인 실패
- **차단 범위**: 이메일과 IP 조합으로 차단
- **차단 기간**: 수동 해제 필요 (자동 해제 옵션 설정 가능)
- **경고 표시**: 3회 실패 시점부터 남은 시도 횟수 표시

#### 환경 설정
`.env` 파일에서 설정 가능:
```env
# 차단 임계값 (기본: 5)
PASSWORD_MAX_ATTEMPTS=5

# 시도 기록 유효 시간 (시간 단위, 기본: 24)
PASSWORD_ATTEMPT_DECAY_HOURS=24

# 자동 차단 해제 시간 (시간 단위, 기본: 없음)
PASSWORD_AUTO_UNBLOCK_HOURS=48
```

### 비밀번호 로그 추적

모든 로그인 시도는 `admin_password_logs` 테이블에 기록됩니다:

| 필드 | 설명 |
|------|------|
| `email` | 시도한 이메일 주소 |
| `ip_address` | 접속 IP 주소 |
| `browser` | 브라우저 정보 |
| `attempt_count` | 누적 시도 횟수 |
| `is_blocked` | 차단 여부 |
| `blocked_at` | 차단 시간 |
| `status` | failed/blocked/resolved |

### 차단 해제 방법

#### 웹 인터페이스 (관리자)
1. `/admin/user/password/logs` 접속
2. 차단된 항목 확인
3. "차단 해제" 버튼 클릭

#### 콘솔 명령 (시스템 관리자)
```bash
# 특정 이메일 차단 해제
php artisan admin:password-unblock email@example.com

# 특정 IP 차단 해제
php artisan admin:password-unblock --ip=192.168.1.1

# 차단된 목록 보기
php artisan admin:password-unblock --show

# 모든 차단 해제
php artisan admin:password-unblock --all
```

### 시도 기록 초기화

```bash
# 특정 이메일 시도 초기화
php artisan admin:password-reset email@example.com

# 특정 IP 시도 초기화
php artisan admin:password-reset --ip=192.168.1.1

# 7일 이전 기록 삭제
php artisan admin:password-reset --days=7
```

## 🔑 2FA 인증 시스템

Google Authenticator 기반의 TOTP(Time-based One-Time Password) 방식 2차 인증을 제공합니다.

### 2FA 설정 방법

#### 1. 2FA 페이지 접속
```
/admin/user/2fa
```

#### 2. 2FA 활성화 프로세스
1. "2FA 설정" 버튼 클릭
2. 현재 비밀번호 입력으로 본인 확인
3. QR 코드 표시
4. Google Authenticator 앱으로 QR 코드 스캔
5. 앱에 표시된 6자리 코드 입력하여 확인
6. 복구 코드 8개 생성 및 안전한 곳에 보관

#### 3. 지원 앱
- Google Authenticator (권장)
- Microsoft Authenticator
- Authy
- 1Password
- 기타 TOTP 표준 지원 앱

### 2FA 로그인 과정

1. 이메일/비밀번호 입력
2. 2FA 코드 입력 페이지로 자동 이동
3. Authenticator 앱에서 6자리 코드 확인
4. 30초 이내에 코드 입력
5. 로그인 완료

### 복구 코드

#### 복구 코드 사용
장치를 분실한 경우 복구 코드로 로그인 가능:
1. 2FA 코드 입력 화면에서 "복구 코드 사용" 클릭
2. 저장해둔 8개 복구 코드 중 하나 입력
3. 로그인 후 새 장치로 2FA 재설정 권장

⚠️ **주의사항**
- 각 복구 코드는 1회만 사용 가능
- 복구 코드는 안전한 곳에 보관 필수
- 모든 복구 코드 소진 시 관리자 문의 필요

### 2FA 관리 기능

#### 사용자별 2FA 상태 확인
```
/admin/user/2fa
```
- 전체 사용자 2FA 활성화 현황
- 마지막 사용 시간
- 설정 완료 여부

#### 강제 비활성화 (관리자)
```php
// 특정 사용자 2FA 비활성화
$user = User::find($userId);
$user->two_factor_enabled = false;
$user->two_factor_secret = null;
$user->two_factor_recovery_codes = null;
$user->save();
```

### 2FA 데이터베이스 구조

users 테이블에 추가된 컬럼:
| 컬럼 | 타입 | 설명 |
|------|------|------|
| `two_factor_secret` | TEXT | 암호화된 비밀 키 |
| `two_factor_recovery_codes` | JSON | 복구 코드 배열 |
| `two_factor_confirmed_at` | TIMESTAMP | 설정 완료 시각 |
| `two_factor_enabled` | BOOLEAN | 활성화 상태 |
| `last_2fa_used_at` | TIMESTAMP | 마지막 사용 시각 |

## 📊 로그 기록

모든 인증 관련 활동은 상세히 기록됩니다.

### 로그인 활동 로그

`admin_user_logs` 테이블에 기록되는 이벤트:

| 액션 | 설명 | 기록 정보 |
|------|------|----------|
| `login` | 로그인 성공 | 이메일, IP, 브라우저, 시간 |
| `logout` | 로그아웃 | 이메일, 세션 지속 시간 |
| `failed_login` | 로그인 실패 | 시도한 이메일, IP, 실패 원인 |
| `password_blocked` | 비밀번호 차단 | 이메일, IP, 시도 횟수 |
| `password_unblocked` | 차단 해제 | 이메일, 해제한 관리자 |
| `2fa_enabled` | 2FA 활성화 | 사용자 ID, 설정 시간 |
| `2fa_disabled` | 2FA 비활성화 | 사용자 ID, 해제 시간 |
| `2fa_verified` | 2FA 인증 성공 | 사용자 ID, 인증 방법 |
| `2fa_failed` | 2FA 인증 실패 | 사용자 ID, 실패 원인 |
| `2fa_recovery_used` | 복구 코드 사용 | 사용자 ID, 사용된 코드 번호 |

### 세션 활동 추적

`admin_user_sessions` 테이블:
- 현재 활성 세션 모니터링
- 동시 접속 세션 관리
- 비정상 세션 패턴 감지
- 세션별 활동 이력

### 로그 조회 및 분석

#### 웹 인터페이스
- **활동 로그**: `/admin/user/logs`
- **비밀번호 로그**: `/admin/user/password/logs`
- **세션 관리**: `/admin/sessions`

#### 대시보드 통계
`/admin/dashboard`에서 실시간 확인:
- 최근 로그인 활동
- 실패한 로그인 시도
- 차단된 IP 목록
- 2FA 사용 통계

## 🚨 보안 모니터링

### 실시간 알림 (계획된 기능)

#### 이메일 알림
- 관리자 계정 5회 로그인 실패
- 새로운 IP에서 관리자 로그인
- 2FA 비활성화 시도

#### 대시보드 알림
- 비정상적인 로그인 패턴 감지
- 다중 IP 동시 접속 시도
- 짧은 시간 내 과도한 시도

### 보안 정책 권장사항

1. **비밀번호 정책**
   - 최소 12자 이상
   - 대소문자, 숫자, 특수문자 포함
   - 3개월마다 변경

2. **2FA 정책**
   - 모든 관리자 계정 필수 적용
   - 정기적인 복구 코드 갱신
   - 장치 변경 시 즉시 재설정

3. **접근 제어**
   - IP 화이트리스트 설정
   - VPN 사용 권장
   - 유휴 시간 자동 로그아웃

## 🛠️ 문제 해결

### Q: 관리자가 차단되었을 때?
```bash
php artisan admin:password-unblock admin@example.com
```

### Q: 2FA 장치를 분실했을 때?
1. 복구 코드 사용하여 로그인
2. 복구 코드도 없는 경우 시스템 관리자가 콘솔에서 2FA 재설정

### Q: "시간이 맞지 않습니다" 2FA 오류?
서버와 장치 시간 동기화 확인:
```bash
# 서버 시간 확인
date

# NTP 동기화
sudo ntpdate -s time.nist.gov
```

### Q: 차단 임계값 변경?
`.env` 파일에서 `PASSWORD_MAX_ATTEMPTS` 값 수정 후:
```bash
php artisan config:clear
```

## 📈 통계 및 리포트

### 월간 보안 리포트
- 총 로그인 수
- 실패한 시도 비율
- 차단된 IP 수
- 2FA 채택률
- 평균 세션 시간

### 감사 로그
- 모든 관리자 활동 추적
- 권한 변경 이력
- 설정 변경 기록
- 데이터 접근 로그

## 🔄 업데이트 내역

### v1.0.0 (2025-09-02)
- 분리된 관리자 로그인 시스템
- 자동 차단 시스템
- Google Authenticator 2FA 통합
- 복구 코드 시스템
- 상세 로그 기록

### 계획된 기능
- [ ] SMS 기반 2FA 옵션
- [ ] 하드웨어 키 (YubiKey) 지원
- [ ] 생체 인증 통합
- [ ] 신뢰할 수 있는 장치 관리
- [ ] 실시간 알림 시스템

---

*이 문서는 @jiny/admin v1.0.0 기준으로 작성되었습니다.*

