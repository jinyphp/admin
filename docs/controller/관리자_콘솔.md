# 관리자 콘솔 명령어 가이드

@jiny/admin 패키지는 관리자 계정을 효율적으로 관리할 수 있는 다양한 콘솔 명령어를 제공합니다.

## 📋 목차

1. [관리자 생성 (admin:user-create)](#관리자-생성)
2. [관리자 삭제 (admin:user-delete)](#관리자-삭제)
3. [관리자 목록 (admin:users)](#관리자-목록)
4. [비밀번호 관리 (admin:user-password)](#비밀번호-관리)

---

## 관리자 생성
새로운 관리자 계정을 생성합니다. 콘솔에서 대화형 모드로 손쉽게 관리자 계정을 생성할 수 있습니다. 
또는, 옵션을 통하여 inline 으로 한번에 관리자 계정을 생성할 수도 있습니다.

### 명령어
관리자 생성 명령은 다음과 같이 터미널에서 입력합니다.

```bash
php artisan admin:user-create [옵션]
```
> 옵션을 지정하지 않으면 대화형 모드로 진행됩니다.

### 옵션
명령어와 같이 옵션으로 입력할 수 있는 항목은 다음과 같습니다.

| 옵션 | 설명 | 예시 |
|------|------|------|
| `--email` | 관리자 이메일 주소 | `--email=admin@example.com` |
| `--name` | 관리자 이름 | `--name="홍길동"` |
| `--password` | 비밀번호 (입력하지 않으면 프롬프트 표시) | `--password=SecurePass123!` |
| `--type` | 관리자 타입 (super, admin, manager 등) | `--type=super` |
| `--random-password` | 랜덤 비밀번호 생성 | `--random-password` |
| `--show-password` | 생성된 비밀번호 표시 | `--show-password` |
| `--force` | 확인 없이 생성 | `--force` |

> 일부 옵션만 제공하면, 제공하지 않은 항목들만 대화형으로 물어 봅니다.

### 사용 예시

#### 대화형 모드로 관리자 생성
```bash
php artisan admin:user-create
```

#### 옵션을 사용한 빠른 생성
```bash
php artisan admin:user-create --email=admin@example.com --name="관리자" --type=super --random-password --show-password
```

#### Super Admin 생성
```bash
php artisan admin:user-create --email=super@example.com --name="최고관리자" --type=super --force
```

### 비밀번호 요구사항
비밀번호 생성 규칙은 `jiny/admin/config/setting.php`의 password 설정을 따릅니다.

**기본 요구사항:**
- 길이: 8자 ~ 128자
- 대문자 포함 필수 (A-Z)
- 소문자 포함 필수 (a-z)
- 숫자 포함 필수 (0-9)
- 특수문자 포함 필수 (!@#$%^&*()_+-=[]{}|;:,.<>?)
- 공백 사용 불가
- 유효기간: 90일 (설정에 따라 변경 가능)

**대화형 모드 특징:**
- 비밀번호 입력 전 규칙과 예제를 자동으로 표시
- 올바른 비밀번호 예제와 잘못된 예제 제공
- 비밀번호 확인을 위해 2번 입력 요구
- 최대 3회까지 재시도 가능

### 관리자 타입
다양한 관리자 타입을 지정할 수 있습니다. `admin_user_types` 테이블의 목록을 참고하여 가입유형을 지정할 수 있습니다.

**기본 제공 타입:**
| 타입 | 이름 | 설명 | 레벨 |
|------|------|------|------|
| `super` | Super Admin | 최고 관리자 - 모든 권한을 가진 시스템 관리자 | 100 |
| `admin` | Administrator | 일반 관리자 - 시스템 설정을 제외한 대부분의 권한 | 50 |
| `staff` | Staff | 스태프 - 콘텐츠 관리 및 기본 운영 권한 | 10 |

> **참고**: 관리자 타입이 없을 경우 자동으로 기본 타입이 생성됩니다.

### 추가 기능

#### 비밀번호 만료 설정
- 생성 시 자동으로 비밀번호 만료일 설정 (config 기반)
- 만료일이 되면 로그인 시 비밀번호 변경 요구

#### 로그 기록
- 모든 관리자 생성 작업은 `admin_user_logs` 테이블에 자동 기록
- 콘솔 실행자 정보, 생성 시간 등 포함

#### 중복 확인
- 이메일 중복 자동 확인
- 기존 관리자 정보 표시

### 주의사항

1. **비밀번호 입력 시 보안**
   - 명령줄에 직접 비밀번호 입력 시 히스토리에 남을 수 있음
   - 대화형 모드 또는 `--random-password` 옵션 권장

2. **타입 유효성**
   - 존재하지 않는 타입 지정 시 오류 발생
   - 대화형 모드에서는 사용 가능한 타입 목록 자동 표시

3. **이메일 형식**
   - 유효한 이메일 형식 필수
   - 실제 메일 발송 여부와 무관하게 형식 검증

---

## 관리자 삭제
기존의 관리자 계정을 삭제합니다.


### 명령어

```bash
php artisan admin:user-delete [ID 또는 이메일] [옵션]
```

### 옵션

| 옵션 | 설명 | 예시 |
|------|------|------|
| `identifier` | 삭제할 관리자 ID 또는 이메일 주소 (인수) | `5` 또는 `admin@example.com` |
| `--force` | 확인 없이 삭제 | `--force` |
| `--soft` | 소프트 삭제 (복구 가능) | `--soft` |

### 사용 예시

#### 대화형 모드로 삭제
```bash
php artisan admin:user-delete
```
대화형 모드에서는 관리자 목록이 표시되며, ID 또는 이메일을 입력하여 삭제할 수 있습니다.

#### ID로 관리자 삭제
```bash
php artisan admin:user-delete 5
```

#### 이메일로 관리자 삭제
```bash
php artisan admin:user-delete admin@example.com
```

#### 강제 삭제 (확인 없이)
```bash
php artisan admin:user-delete 5 --force
php artisan admin:user-delete admin@example.com --force
```

#### 소프트 삭제 (복구 가능)
```bash
php artisan admin:user-delete 5 --soft
php artisan admin:user-delete admin@example.com --soft
```

### 주의사항

- **마지막 관리자는 삭제할 수 없습니다** (시스템에 최소 1명의 관리자 필요)
- **마지막 Super Admin 삭제 시 경고** 표시
- 삭제 전 관련 데이터(로그인 로그, 세션, 비밀번호 로그) 확인
- 삭제 확인을 위해 "DELETE" 입력 필요 (--force 옵션 미사용 시)

### 삭제 방식

#### 하드 삭제
- 데이터베이스에서 완전히 삭제
- 복구 불가능
- 기본 동작

#### 소프트 삭제 (--soft)
- `isAdmin`을 false로 변경
- `deleted_at` 타임스탬프 기록
- 필요시 데이터베이스에서 복구 가능

---

## 관리자 목록

등록된 모든 관리자의 목록을 표시합니다. 기본적으로 관리자 테이블만 표시되며, 옵션을 통해 추가 정보를 볼 수 있습니다.

### 명령어

```bash
php artisan admin:users [옵션]
```

### 옵션

#### 필터링 옵션
| 옵션 | 설명 | 예시 |
|------|------|------|
| `--type` | 특정 관리자 타입만 표시 | `--type=super` |
| `--active` | 활성 세션이 있는 관리자만 표시 | `--active` |
| `--inactive` | 비활성 관리자만 표시 | `--inactive` |
| `--sort` | 정렬 기준 (created, login, name, email) | `--sort=login` |
| `--desc` | 내림차순 정렬 | `--desc` |
| `--limit` | 표시할 최대 개수 | `--limit=10` |
| `--export` | 결과를 CSV 파일로 내보내기 | `--export=admins.csv` |

#### 추가 정보 표시 옵션
| 옵션 | 단축 | 설명 | 예시 |
|------|------|------|------|
| `--stats` | `-s` | 통계 정보 표시 | `--stats` 또는 `-s` |
| `--types` | `-t` | 관리자 타입별 현황 표시 | `--types` 또는 `-t` |
| `--activity` | `-a` | 최근 활동 정보 표시 | `--activity` 또는 `-a` |
| `--all` | | 모든 추가 정보 표시 | `--all` |

### 사용 예시

#### 기본 관리자 목록 표시 (테이블만)
```bash
php artisan admin:users
```

#### 통계 정보와 함께 표시
```bash
php artisan admin:users -s
# 또는
php artisan admin:users --stats
```

#### 여러 추가 정보 함께 표시
```bash
php artisan admin:users -s -t
# 통계와 타입별 현황 표시
```

#### 모든 정보 표시 (이전 버전과 동일)
```bash
php artisan admin:users --all
```

#### Super Admin만 표시
```bash
php artisan admin:users --type=super
```

#### 최근 로그인 순으로 정렬
```bash
php artisan admin:users --sort=login --desc
```

#### 활성 관리자만 표시
```bash
php artisan admin:users --active
```

#### CSV로 내보내기
```bash
php artisan admin:users --export=/path/to/admins.csv
```

### 표시 정보

#### 기본 테이블 (기본 출력)
- ID (⭐로 강조 표시)
- 이메일
- 이름
- 타입
- 상태 (활성/휴면/비활성/차단됨/비밀번호 만료)
- 마지막 로그인
- 로그인 횟수
- 생성일

#### 통계 정보 (--stats 또는 -s 옵션)
- 총 관리자 수
- 타입별 관리자 수
- 최근 30일 활성 사용자
- 30일 이상 비활성 사용자
- 2FA 활성화 사용자
- 비밀번호 만료 예정 사용자

#### 타입별 현황 (--types 또는 -t 옵션)
- 관리자 타입 코드
- 타입 이름
- 권한 레벨
- 전체 사용자 수
- 활성 사용자 수
- 타입 설명

#### 최근 활동 (--activity 또는 -a 옵션)
- 최근 로그인한 관리자
- 최근 생성된 관리자
- 비밀번호 만료 예정 관리자
- 90일 이상 미접속 관리자

### 상태 아이콘

| 아이콘 | 의미 |
|--------|------|
| ✅ | 활성 (7일 이내 로그인) |
| 😴 | 휴면 (7-30일 사이 로그인) |
| 💤 | 비활성 (30일 이상 미접속) |
| 🔒 | 차단됨 |
| ⚠️ | 비밀번호 만료 |
| 🔑 | 비밀번호 변경 필요 |

---

## 비밀번호 관리

관리자 계정의 비밀번호 재설정 및 차단 해제를 통합 관리합니다.

### 명령어

```bash
php artisan admin:user-password [action] [identifier] [옵션]
```

### 액션

| 액션 | 설명 |
|------|------|
| `reset` | 비밀번호 재설정 (기본값) |
| `unblock` | 차단 해제 |

### 옵션

#### 비밀번호 재설정 옵션 (reset 액션)
| 옵션 | 설명 | 예시 |
|------|------|------|
| `identifier` | 이메일 주소 또는 사용자 ID | `admin@example.com` 또는 `5` |
| `--password` | 새 비밀번호 (입력하지 않으면 프롬프트 표시) | `--password=NewPass123!` |
| `--random` | 랜덤 비밀번호 생성 | `--random` |
| `--show` | 생성된 비밀번호 표시 | `--show` |

#### 차단 해제 옵션 (unblock 액션)
| 옵션 | 설명 | 예시 |
|------|------|------|
| `identifier` | 이메일 주소 또는 사용자 ID | `admin@example.com` 또는 `5` |
| `--ip` | 차단 해제할 IP 주소 | `--ip=192.168.1.1` |
| `--days` | X일 이전의 시도 초기화 (기본값: 1) | `--days=7` |
| `--all` | 모든 차단 해제 | `--all` |

### 사용 예시

#### 비밀번호 재설정 (기본 액션)

##### 대화형 모드로 비밀번호 재설정
```bash
php artisan admin:user-password
# 또는 명시적으로
php artisan admin:user-password reset
```

##### 특정 관리자의 비밀번호 재설정
```bash
php artisan admin:user-password reset admin@example.com
# ID로도 가능
php artisan admin:user-password reset 5
```

##### 랜덤 비밀번호 생성 및 표시
```bash
php artisan admin:user-password reset admin@example.com --random --show
```

#### 차단 해제

##### 특정 계정 차단 해제
```bash
php artisan admin:user-password unblock admin@example.com
# ID로도 가능
php artisan admin:user-password unblock 5
```

##### 특정 IP의 차단 해제
```bash
php artisan admin:user-password unblock --ip=192.168.1.1
```

##### 모든 차단된 계정 해제
```bash
php artisan admin:user-password unblock --all
```

##### 7일 이전의 차단 해제
```bash
php artisan admin:user-password unblock --days=7
```

### 특징

#### 비밀번호 재설정 시
- 비밀번호 변경 시 로그 자동 기록
- 비밀번호 만료일 자동 설정 (설정에 따라)
- 강제 비밀번호 변경 플래그 자동 해제
- 이전 비밀번호 해시 보관 (감사 목적)
- **자동으로 해당 계정의 차단 해제**

#### 차단 해제 시
- 5회 연속 로그인 실패 시 자동 차단된 계정 해제
- 차단 시간: 30분 (설정 가능)
- 차단 해제 후 시도 횟수 초기화
- 모든 해제 작업 로그 기록

---

## 보안 권장사항

### 관리자 계정 관리

1. **정기적인 비밀번호 변경**
   - 90일마다 비밀번호 변경 권장
   - 비밀번호 만료 정책 설정

2. **최소 권한 원칙**
   - 필요한 최소한의 권한만 부여
   - Super Admin 계정 최소화

3. **계정 모니터링**
   - 정기적으로 `admin:users --inactive` 실행
   - 장기 미사용 계정 삭제 또는 비활성화

4. **2FA 활성화**
   - 모든 관리자 계정에 2FA 설정 권장
   - 특히 Super Admin은 필수

### 비밀번호 정책

1. **복잡성 요구사항**
   - 최소 8자 이상 (권장 12자 이상)
   - 대소문자, 숫자, 특수문자 조합

2. **비밀번호 생성기 활용**
   - `--random-password` 옵션 사용
   - 16자 이상의 강력한 비밀번호 자동 생성

3. **비밀번호 재사용 방지**
   - 이전 사용 비밀번호 기록
   - 최근 5개 비밀번호 재사용 방지

### 감사 로그

모든 관리자 관련 작업은 자동으로 로그에 기록됩니다:

- 관리자 생성/삭제
- 비밀번호 변경
- 로그인 시도 (성공/실패)
- 차단/차단 해제

로그 확인:
```sql
-- admin_user_logs 테이블에서 확인
SELECT * FROM admin_user_logs ORDER BY created_at DESC;
```

---

## 문제 해결

### 일반적인 문제

#### 1. "마지막 관리자는 삭제할 수 없습니다" 오류
- **원인**: 시스템에 최소 1명의 관리자 필요
- **해결**: 새 관리자를 먼저 생성 후 삭제

#### 2. 비밀번호가 요구사항을 충족하지 않음
- **원인**: 비밀번호 정책 미충족
- **해결**: 대소문자, 숫자, 특수문자를 포함한 8자 이상 비밀번호 사용

#### 3. 계정이 차단됨
- **원인**: 연속된 로그인 실패
- **해결**: `admin:user-password unblock` 명령 실행

#### 4. CSV 내보내기 시 한글 깨짐
- **원인**: 인코딩 문제
- **해결**: UTF-8 BOM이 자동 추가되므로 Excel에서 정상 표시

### 디버깅

문제 발생 시 다음 정보 확인:

1. **Laravel 로그**
   ```bash
   tail -f storage/logs/laravel.log
   ```

2. **관리자 활동 로그**
   ```bash
   php artisan admin:users --export=debug.csv
   ```

3. **데이터베이스 직접 확인**
   ```sql
   SELECT * FROM users WHERE isAdmin = 1;
   SELECT * FROM admin_user_logs ORDER BY created_at DESC LIMIT 10;
   ```

---

## 자동화 예시

### 일일 관리자 현황 리포트

```bash
#!/bin/bash
# daily-admin-report.sh

DATE=$(date +%Y%m%d)
REPORT_DIR="/var/reports/admin"

# 디렉토리 생성
mkdir -p $REPORT_DIR

# 관리자 목록 내보내기
php artisan admin:users --export=$REPORT_DIR/admins_$DATE.csv

# 비활성 관리자 확인
php artisan admin:users --inactive > $REPORT_DIR/inactive_$DATE.txt

# 이메일로 전송 (선택적)
# mail -s "Daily Admin Report" admin@example.com < $REPORT_DIR/inactive_$DATE.txt
```

### 정기적인 차단 해제

```bash
# crontab -e
# 매일 자정에 7일 이상 된 차단 해제
0 0 * * * php /path/to/artisan admin:user-password unblock --days=7
```

### 비활성 계정 알림

```bash
#!/bin/bash
# check-inactive-admins.sh

INACTIVE=$(php artisan admin:users --inactive --limit=10)

if [ ! -z "$INACTIVE" ]; then
    echo "비활성 관리자 발견:" | mail -s "Inactive Admin Alert" security@example.com
fi
```

---

## 추가 리소스

- [Laravel 공식 문서](https://laravel.com/docs)
- [Artisan 콘솔 가이드](https://laravel.com/docs/artisan)
- [@jiny/admin 패키지 문서](../README.md)

---

*최종 업데이트: 2025년 9월 14일 - 명령어 이름 변경 및 통합*
